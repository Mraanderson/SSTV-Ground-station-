{% extends "base.html" %}
{% block title %}Upcoming ISS Passes{% endblock %}
{% block content %}
<div class="card p-3">

  <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
    <div>
      <h2 class="mb-0">Upcoming ISS Passes</h2>
      <small class="text-muted">(Next 24 Hours)</small>
    </div>
    <div class="d-flex align-items-center gap-3">
      <div class="form-check form-switch mb-0">
        <input class="form-check-input" type="checkbox" id="timeToggle" {% if not show_local_time %}checked{% endif %}>
        <label class="form-check-label" for="timeToggle">Show UTC</label>
      </div>
      <button id="updateTleBtn" class="btn btn-sm btn-primary">Update TLE</button>
    </div>
  </div>

  <small class="text-muted mb-2 d-block" id="diagnosticsLine">
    üõ∞ <strong>TLE epoch (UTC):</strong> {{ info.tle_epoch_utc }} ¬∑
    ‚è≥ <strong>TLE age:</strong> {{ info.tle_age_days }} days ¬∑
    üìç <strong>Observer:</strong> lat {{ info.observer.lat }}, lon {{ info.observer.lon }}, alt {{ info.observer.alt_m }} m ¬∑
    üéØ <strong>Min elev:</strong> {{ info.min_elev_deg }}¬∞ ¬∑
    <span id="timeModeLabel"><strong>Time mode:</strong> {{ 'Local' if show_local_time else 'UTC' }}</span>
  </small>

  {% if message %}
    <div class="alert alert-warning">{{ message }}</div>
  {% elif passes %}
    <div class="table-responsive">
      <table class="table table-dark table-striped table-hover align-middle" id="passesTable">
        <thead>
          <tr>
            <th id="aosHeader">AOS ({{ 'Local' if show_local_time else 'UTC' }})</th>
            <th id="losHeader">LOS ({{ 'Local' if show_local_time else 'UTC' }})</th>
            <th class="text-center">Max Elev (¬∞)</th>
            <th class="text-center">Duration (s)</th>
          </tr>
        </thead>
        <tbody>
          {% for p in passes %}
          {% set now = namespace(highlight='') %}
          {% if p.aos <= current_time <= p.los %}
            {% set now.highlight = 'table-warning' %}
          {% elif p.aos <= current_time + timedelta(hours=1) and p.aos > current_time %}
            {% set now.highlight = 'table-info' %}
          {% endif %}
          <tr class="{{ now.highlight }}">
            <td data-utc="{{ p.aos.strftime('%Y-%m-%dT%H:%M:%SZ') }}">{{ p.aos.strftime('%Y-%m-%d %H:%M:%S') }}</td>
            <td data-utc="{{ p.los.strftime('%Y-%m-%dT%H:%M:%SZ') }}">{{ p.los.strftime('%Y-%m-%d %H:%M:%S') }}</td>
            <td class="text-center">{{ '%.1f'|format(p.max_elev) }}</td>
            <td class="text-center">{{ p.duration }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p class="text-light">No ISS passes found in the next 24 hours.</p>
  {% endif %}

  <div id="tleMessage" class="mt-3" style="display:none;"></div>
</div>

<script>
function setDisplayMode(showUTC) {
  const rows = document.querySelectorAll('#passesTable tbody tr');
  rows.forEach(row => {
    row.querySelectorAll('td[data-utc]').forEach(cell => {
      const utcString = cell.getAttribute('data-utc');
      const date = new Date(utcString);
      cell.textContent = showUTC ? utcString.replace('T', ' ').replace('Z', '') : date.toLocaleString();
    });
  });
  document.getElementById('aosHeader').textContent = `AOS (${showUTC ? 'UTC' : 'Local'})`;
  document.getElementById('losHeader').textContent = `LOS (${showUTC ? 'UTC' : 'Local'})`;
  document.getElementById('timeModeLabel').innerHTML = `<strong>Time mode:</strong> ${showUTC ? 'UTC' : 'Local'}`;
}

document.addEventListener('DOMContentLoaded', function() {
  const showUTC = document.getElementById('timeToggle').checked;
  setDisplayMode(showUTC);
});

document.getElementById('timeToggle').addEventListener('change', function() {
  const showUTC = this.checked;
  setDisplayMode(showUTC);
  fetch("{{ url_for('set_time_display') }}", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ show_local_time: !showUTC })
  });
});

document.getElementById('updateTleBtn').addEventListener('click', function() {
  fetch("{{ url_for('update_tle') }}", { method: "POST" })
    .then(res => {
      if (res.ok) {
        document.getElementById('tleMessage').className = 'alert alert-success';
        document.getElementById('tleMessage').textContent = 'TLE updated successfully.';
        document.getElementById('tleMessage').style.display = 'block';
        setTimeout(() => { document.getElementById('tleMessage').style.display = 'none'; }, 5000);
      } else {
        document.getElementById('tleMessage').className = 'alert alert-danger';
        document.getElementById('tleMessage').textContent = 'Error updating TLE.';
        document.getElementById('tleMessage').style.display = 'block';
      }
    })
    .catch(() => {
      document.getElementById('tleMessage').className = 'alert alert-danger';
      document.getElementById('tleMessage').textContent = 'Error updating TLE.';
      document.getElementById('tleMessage').style.display = 'block';
    });
});
</script>
{% endblock %}
            
