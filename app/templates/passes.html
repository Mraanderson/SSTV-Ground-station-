{% extends "base.html" %}
{% block title %}Upcoming ISS Passes{% endblock %}

{% block content %}
<div class="card p-3 bg-secondary text-light">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">Upcoming ISS Passes (Next 24 Hours)</h2>
    <div class="form-check form-switch">
      <input class="form-check-input" type="checkbox" id="timeToggle" {% if show_local_time %}checked{% endif %}>
      <label class="form-check-label" for="timeToggle">Show in local time</label>
    </div>
  </div>

  <!-- Update TLE button + last updated -->
  <div class="d-flex align-items-center mb-3">
    <form method="post" action="{{ url_for('update_tle') }}" class="me-3">
      <button type="submit" class="btn btn-sm btn-primary">Update TLE</button>
    </form>
    <small class="text-muted">Last updated: {{ tle_last_updated }}</small>
  </div>

  <!-- Diagnostics -->
  {% if info %}
  <div class="small text-muted mb-2">
    <span><strong>TLE epoch (UTC):</strong> {{ info.tle_epoch_utc }}</span> ·
    <span><strong>TLE age:</strong> {{ info.tle_age_days }} days</span> ·
    <span><strong>Observer:</strong> lat {{ info.observer.lat }}, lon {{ info.observer.lon }}, alt {{ info.observer.alt_m }} m</span> ·
    <span><strong>Min elev:</strong> {{ info.min_elev_deg }}°</span>
  </div>
  {% endif %}

  {% if message %}
    <div class="alert alert-warning">{{ message }}</div>
  {% elif passes %}
    <table class="table table-dark table-striped table-hover align-middle" id="passesTable">
      <thead>
        <tr>
          <th>AOS</th>
          <th>LOS</th>
          <th>Max Elev (°)</th>
          <th>Duration (s)</th>
        </tr>
      </thead>
      <tbody>
        {% for p in passes %}
        <tr>
          <!-- Safe UTC format for JS parsing -->
          <td data-utc="{{ p.aos.strftime('%Y-%m-%dT%H:%M:%SZ') }}">{{ p.aos.strftime('%Y-%m-%d %H:%M:%S') }}</td>
          <td data-utc="{{ p.los.strftime('%Y-%m-%dT%H:%M:%SZ') }}">{{ p.los.strftime('%Y-%m-%d %H:%M:%S') }}</td>
          <td>{{ '%.1f'|format(p.max_elev) }}</td>
          <td>{{ p.duration }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p class="text-muted">No ISS passes found in the next 24 hours.</p>
  {% endif %}
</div>

<!-- Timezone toggle script -->
<script>
document.getElementById('timeToggle').addEventListener('change', function() {
  const rows = document.querySelectorAll('#passesTable tbody tr');
  rows.forEach(row => {
    row.querySelectorAll('td[data-utc]').forEach(cell => {
      const utcString = cell.getAttribute('data-utc');
      const date = new Date(utcString);
      if (this.checked) {
        cell.textContent = date.toLocaleString();
      } else {
        cell.textContent = utcString.replace('T', ' ').replace('Z', '');
      }
    });
  });

  // Save preference to config.json via backend
  fetch("{{ url_for('set_time_display') }}", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ show_local_time: this.checked })
  });
});
</script>
{% endblock %}
