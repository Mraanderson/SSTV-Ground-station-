{% extends "base.html" %}
{% block title %}Configuration{% endblock %}
{% block content %}
<div class="card p-3 position-relative">

  <h2 class="mb-3">Configuration</h2>
  {% if message %}<div class="alert alert-info">{{ message }}</div>{% endif %}

  <!-- Single form containing everything -->
  <form method="post" id="configForm">

    <!-- Save button top-right -->
    <div class="position-absolute top-0 end-0 m-3">
      <button type="submit" class="btn btn-primary btn-sm">Save</button>
    </div>

    <!-- Lat/Lon side-by-side -->
    <div class="row mb-3">
      <div class="col-md-6">
        <label class="form-label">Latitude</label>
        <input type="text" class="form-control" id="lat" name="location_lat" value="{{ config_data.location_lat }}">
      </div>
      <div class="col-md-6">
        <label class="form-label">Longitude</label>
        <input type="text" class="form-control" id="lon" name="location_lon" value="{{ config_data.location_lon }}">
      </div>
    </div>

    <!-- Altitude -->
    <div class="mb-3">
      <label class="form-label">Altitude (m)</label>
      <input type="text" class="form-control" id="alt" name="location_alt" value="{{ config_data.location_alt }}">
    </div>

    <!-- Timezone -->
    <div class="mb-3">
      <label class="form-label">Timezone</label>
      <input type="text" class="form-control" id="tz" name="timezone" value="{{ config_data.timezone }}">
      <div class="form-text">Example: Europe/London</div>
    </div>

    <!-- Show local time toggle -->
    <div class="form-check mb-3">
      <input class="form-check-input" type="checkbox" name="show_local_time" {% if config_data.show_local_time %}checked{% endif %}>
      <label class="form-check-label">Show Local Time by Default</label>
    </div>

    <!-- Map -->
    <div id="map" style="height: 300px;" class="mb-3"></div>

  </form>
</div>

<!-- Leaflet CSS & JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const latInput = document.getElementById('lat');
  const lonInput = document.getElementById('lon');
  const altInput = document.getElementById('alt');
  const tzInput = document.getElementById('tz');

  const startLat = parseFloat(latInput.value) || 0;
  const startLon = parseFloat(lonInput.value) || 0;

  const map = L.map('map').setView([startLat, startLon], 4);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  let marker = L.marker([startLat, startLon]).addTo(map);

  map.on('click', function(e) {
    const { lat, lng } = e.latlng;
    latInput.value = lat.toFixed(6);
    lonInput.value = lng.toFixed(6);
    marker.setLatLng([lat, lng]);

    // Fetch altitude
    fetch(`https://api.open-elevation.com/api/v1/lookup?locations=${lat},${lng}`)
      .then(res => res.json())
      .then(data => {
        if (data.results && data.results.length > 0) {
          altInput.value = data.results[0].elevation;
        }
      });

    // Fetch timezone from backend (timezonefinder)
    fetch(`/get-timezone?lat=${lat}&lon=${lng}`)
      .then(res => res.json())
      .then(data => {
        if (data.timezone) {
          tzInput.value = data.timezone;
        }
      });
  });
});
</script>
{% endblock %}
